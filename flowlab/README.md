## Flowlab
A simple computational fluid dynamics solver
* segregated solver employing the SIMPLE pressure-velocity coupling scheme
* unstructured meshes
* 2D or 3D geometries
* velocity inlet, wall, symmetry and flow outlet boundary conditions
* serial or parallel via domain decomposition and MPI communication
* written C++ and Fortran 90
* built using gmake

<p align="center">
<img src="https://cloud.githubusercontent.com/assets/2945268/6922756/6699101c-d7c5-11e4-85c4-f4c1cceb1cc1.png" alt="pressure in duct" align="middle" width="300" style="border:2px">
<p align="center">Pressure in duct from partitions 1 and 3</p>
</p>

## Requirements
### build tools
* g++ [sudo apt-get install g++]
* gfortran [sudo apt-get install gfortran]
* gmake

### libraries
* LAPACK [sudo apt-get install libblas-dev liblapack-dev]
* openmpi (parallel only) [sudo apt-get install libblas-dev libopenmpi-dev]

### user tools
* [gmsh](http://geuz.org/gmsh/) [sudo apt-get install gmsh]


## Build
### serial
```
  $ make
```

### parallel
```
  $ make mpi=yes
```


## Run
### serial
```
  $ cd bin/
  $ ./flowlab.exe ../examples/cavity_2d/cavity_2d.json
  $ cd ../examples/cavity_2d/
  $ gmsh cavity_2d.geo cavity_2d.msh vel.msh pres.msh
```

### parallel
```
  $ cd bin/
  $ mpirun -n 4 ./flowlab.exe ../examples/cavity_2d/cavity_2d.json part
  $ mpirun -n 4 ./flowlab.exe ../examples/cavity_2d/cavity_2d.json
  $ cd ../examples/cavity_2d/
  $ gmsh cavity_2d.geo cavity_2d.msh_p* vel.msh_p* pres.msh_p*
```


## Known issues
* If a mesh is not generated by Gmsh, but rather converted to Gmsh, that mesh may need to be preprocessed serially by flowlab before being partitioned. This may be required because at present flowlab assumes the elements in the gmsh file are ordered according to boundary elements then domain elements.
* Parallel runs are generally slower than serial because the linear system solvers are different. In serial BiGC-stab is used and in parallel GMRes is used.


## Development
* Convert the Fortran code to C++
* Provide duplicate face and duplicate vertex maps along partitions
* Use a consisent linear solver in serial and parallel
* Improve boundary condition definitions
* Solve temperature equation
* Implement adjoint derivative

### Adjoint of iterative linear solver
```
PRIMAL:
solve: A . x = b

TANGENT:
solve: A . x_tng = b_tng - A_tng . x

ADJOINT:
solve: A.trans . beta = x_adj
b_adj += beta
A_adj -= beta . x.trans
x_adj -= A.trans . beta

N.B. if the `solve' is not fully converged,
i.e. beta != A.trans.inv . x_adj
the last operation becomes
x^0_adj = x_adj - A.trans . beta
```
